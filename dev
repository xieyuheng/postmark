#!/usr/bin/env node

process.on("unhandledRejection", (error) => {
  console.error(error)
  process.exit(1)
})

const { run, test, expect, snapshot, info } = require("@xieyuheng/test-runner")
const changeCase = require("change-case")
const path = require("path")
const fs = require("fs")

let commands = {}

commands.t = async () => {
  await commands.test_all()
}

commands.test_all = async () => {
  await commands.test_lib()
  await commands.test_snapshot()
  await commands.test_postmark_format()
  await commands.test_postmark_render()
}

commands.test_lib = async () => {
  await test("node $file", { file: "lib/**/*.test.js" }, expect.ok)
}

commands.test_snapshot = async () => {
  await test(
    "node $file",
    { file: "lib/**/*.snapshot.js" },
    snapshot.out(({ file }) =>
      path.resolve("snapshot", changeCase.paramCase(file) + ".out")
    )
  )
}

commands.test_postmark_format = async () => {
  await test(
    "./bin/postmark.js format $file",
    { file: "examples/**/*.md" },
    snapshot.out(({ file }) => file + ".format.out")
  )
}

commands.test_postmark_render = async () => {
  await test(
    "./bin/postmark.js render $file",
    { file: "examples/**/*.md" },
    snapshot.out(({ file }) => file + ".render.out")
  )
}

info()

run(commands)
